<% if (isAdmin) { %>
  <%- include('./layout/header_auth') %>
<% } else { %>
  <%- include('./layout/header') %>
<% } %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/flagReport.css">

<div class="container py-4">
  <a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">&larr; Go Back</a>

  <h2 class="mb-4">Flag Report</h2>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><strong><%= word.word %></strong></h5>
      <p class="card-text">"<%= word.translation %>"</p>

      <% if (word.similarWords.length > 0) { %>
        <ul class="list-group list-group-flush">
          <% word.similarWords.forEach(similar => { %>
            <li class="list-group-item">
              <em><%= similar.type %></em> "<%= similar.prefix %>" â†’
            </li>
          <% }); %>
        </ul>
      <% } %>
    </div>
  </div>

  <form id="flagForm">
    <div class="mb-3">
      <label for="flagReason" class="form-label">Flag Category</label>
      <select name="flagReason" id="flagReason" class="form-select" required>
        <option value="Translation">Translation</option>
        <option value="Audio">Audio</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Description</label>
      <textarea name="description" id="description" class="form-control" placeholder="Describe what this flag is about" required></textarea>
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.getElementById('flagForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const flagReason = document.getElementById('flagReason').value;
    const description = document.getElementById('description').value;
    const wordId = "<%= word._id %>";
    const isAdmin = `<%= isAdmin %>`;
    const url = isAdmin ? `/admin/flag/${wordId}` : `/flag/${wordId}`;

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ flagReason, description })
      });

      if (!response.ok) throw new Error('Something went wrong.');

      Swal.fire({
        icon: 'success',
        title: 'Thank you!',
        text: 'Your feedback is taken under consideration.',
        confirmButtonText: 'OK'
      }).then(() => {
        window.location.href = '/';
      });
    } catch (error) {
      console.error(error);
      Swal.fire({
        icon: 'error',
        title: 'Oops!',
        text: 'There was an error submitting your feedback. Please try again later.'
      });
    }
  });
</script>


<% if (isAdmin) { %>
  <%- include('./layout/footer_auth') %>
<% } else { %>
  <%- include('./layout/footer') %>
<% } %>
