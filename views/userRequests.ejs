<%- include('./layout/header_auth') %>
<link href="/css/userList.css" rel="stylesheet" />

  <button class="goBackBtn headerFont semi-bold  hoverable hoverableBtn">
    <a href="/admin/translations">
      <i class="fa-solid fa-arrow-left"></i> Go Back
    </a>
  </button>

  <div class="userListWrap">
    <div class="listTitle headerFont">
      <h2 class="semi-bold">User Requests</h2>
    </div>

    <div class="userTableWrap">
      <% if (typeof error !=="undefined" && error) { %>
        <div class="alert alert-danger">
          <%= error %>
        </div>
      <% } %>

      <table class="userTable">
        <thead>
          <tr class="entryTitle">
            <!-- <th>ID</th> -->
            <th>Email</th>
            <th>Username</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% if (dataEntryUsers.length === 0) { %>
            <tr>
              <td colspan="5" class="text-center">No Data Input Users found</td>
            </tr>
          <% } else { %>
            <% dataEntryUsers.forEach((ele) => { %>
              <tr class="entry">
                <td><%= ele.email %></td>
                <td><%= ele.username %></td>
                <td class="btnWrap">
                  <!-- <a href="/admin/users/edit/<%= ele._id %>" class="btn btn-warning hoverable hoverableBtn">
                    <i class="fa-solid fa-arrow-right"></i>
                  </a> -->
                  <button class="btn btn-warning hoverable hoverableBtn seeUserDetail"
                    onclick="showDetailModal('<%= ele._id %>', '<%= ele.email %>', '<%= ele.username %>', '<%= ele.message %>')">
                    <i class="fa-solid fa-arrow-right"></i>
                  </button>
                  <button class="btn btn-danger hoverable hoverableBtn"
                    onclick="showDeleteModal('<%= ele._id %>', '<%= ele.email %>')">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            <% }); %>
          <% } %>          
        </tbody>
      </table>

      <!-- Pagination -->
      
    </div>
  </div>

  <!-- User Detail Modal -->
  <div class="modalWrap" id="userDetailModal">
    <div class="modal">
      <div class="headerFont semi-bold modalTitle" id="userDetailModalLabel">User Details</div>
      <form id="inviteUserForm" class="modalForm">
        <div class="inputWrap">
          <label for="userEmail" class="form-label">Email</label>
          <input type="email" disabled class="form-control" id="userEmail" value="User Email">
        </div>
        <div class="inputWrap">
          <label for="userName" class="form-label">Username</label>
          <input type="text" disabled class="form-control" id="userName" required>
        </div>
        <div class="inputWrap">
          <label for="userMessage" class="form-label">Message</label>
          <textarea
            id="userMessage"
            class="textArea"
            rows="4"
            disabled
          ></textarea>
        </div>
        <div class="alert alert-danger d-none" id="approvalError"></div>
        <div class="alert alert-success d-none" id="approvalSuccess"></div>
      </form>
      <div class="modalBtnWrap">
        <button type="button" class="textBtn hoverable hoverableBtn" data-bs-dismiss="modal"
          id="cancelApproval">Cancel</button>
        <button type="button" class="textBtn btn-danger hoverable hoverableBtn" id="confirmApproval">Approve User</button>
      </div>
    </div>
  </div>

  <!-- Delete User Modal -->
  <div class="modalWrap" id="deleteUserModal">
    <div class="modal">
      <div class="headerFont semi-bold modalTitle" id="inviteUserModalLabel">Decline User?</div>
      <div class="modalForm">
        <p>Are you sure you want to decline <strong id="deleteUserEmail"></strong>?</p>
        <div class="alert alert-danger d-none" id="deleteError"></div>
        <div class="alert alert-success d-none" id="deleteSuccess"></div>
      </div>
      <div class="modalBtnWrap">
        <button type="button" class="textBtn hoverable hoverableBtn" data-bs-dismiss="modal"
          id="cancelDeleteButton">Cancel</button>
        <button type="button" class="textBtn btn-danger hoverable hoverableBtn" id="confirmDeleteButton">Delete</button>
      </div>
      <button type="button" class="btn closeModalBtn btn-danger hoverable hoverableBtn" data-bs-dismiss="modal" aria-label="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </div>

  <%- include('./layout/footer_auth') %>

  <script>

    let deleteUserId = null;

    // Closing modals
    document.getElementById("cancelDeleteButton").addEventListener("click", () => {
      document.getElementById(document.getElementById("cancelDeleteButton").parentElement.parentElement.parentElement.id).classList.remove("modalToggled");
    });

    document.getElementById("cancelApproval").addEventListener("click", () => {
      document.getElementById(document.getElementById("cancelApproval").parentElement.parentElement.parentElement.id).classList.remove("modalToggled");
    })

    // Function to show the delete modal
    function showDeleteModal(userId, email) {
      deleteUserId = userId;
      document.getElementById("deleteUserEmail").textContent = email;
      document.getElementById("deleteUserModal").classList.add("modalToggled")
    }

    // Function to show the user detail modal
    function showDetailModal(userId, email, username, message) {
      deleteUserId = userId;
      document.getElementById("userEmail").value = email;
      document.getElementById("userName").value = username;
      document.getElementById("userMessage").value = message;
      document.getElementById("userDetailModal").classList.add("modalToggled")
    }

    // Function to handle user deletion
    document.getElementById("confirmDeleteButton").addEventListener("click", async function () {
      if (!deleteUserId) return;

      try {
        const response = await fetch(`/admin/userRequests/delete/${deleteUserId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();
        const deleteError = document.getElementById("deleteError");
        const deleteSuccess = document.getElementById("deleteSuccess");

        deleteError.classList.remove("displayAlert");
        deleteSuccess.classList.remove("displayAlert");

        if (!response.ok) {
          deleteError.textContent = data.message || "An error occurred.";
          deleteError.classList.add("displayAlert");
        } else {
          deleteSuccess.textContent = "delete sent successfully!";
          deleteSuccess.classList.add("displayAlert");
          setTimeout(() => {
            location.reload();
          }, 20);
        }
      } catch (error) {
        deleteError.textContent = "Server error. Please try again.";
        deleteError.classList.add("displayAlert");
      }
    });

    document.getElementById("userDetailModal").addEventListener("submit", async function (event) {
      event.preventDefault();

      const email = document.getElementById("userEmail").value;
      const approvalError = document.getElementById("approvalError");
      const approvalSuccess = document.getElementById("approvalSuccess");
      const approvalButton = document.getElementById("confirmApproval");

      approvalError.classList.remove("displayAlert");
      approvalSuccess.classList.remove("displayAlert");

      approvalButton.disabled = true;

      try {
        const response = await fetch("/admin/users/invite", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await response.json();
        approvalButton.disabled = false;

        if (!response.ok) {
          approvalError.textContent = data.message || "An error occurred.";
          approvalError.classList.add("displayAlert");
        } else {
          approvalSuccess.textContent = "Invite sent successfully!";
          approvalSuccess.classList.add("displayAlert");
        }
      } catch (error) {
        approvalError.textContent = "Server error. Please try again.";
        approvalError.classList.add("displayAlert");
      }
    });
  </script>