<%- include('./layout/header_auth') %>

<div class="container my-4 px-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap">
    <h2 class="mb-3 semi-bold">Words Translation</h2>

    <button class="btn btn-primary mb-3">
      <a href="/admin/translations/add-word" class="text-white text-decoration-none">
        <i class="fa-solid fa-plus"></i> Add New Translation
      </a>
    </button>
  </div>

  <form action="/admin/translations" method="GET">
    <div class="row g-2 align-items-center mb-3">
      <div class="col-md-4">
        <input type="text" name="query" class="form-control" placeholder="Search for a word..."
          value="<%= query %>" />
      </div>
      <div class="col-md-3">
        <select name="filter" class="form-select">
          <option value="all" <%= filter === "all" ? "selected" : "" %>>All Words</option>
          <option value="with_audio" <%= filter === "with_audio" ? "selected" : "" %>>With Audio</option>
          <option value="without_audio" <%= filter === "without_audio" ? "selected" : "" %>>Without Audio</option>
        </select>
      </div>
      <div class="col-md-3">
        <select name="order" class="form-select">
          <option value="asc" <%= order === "asc" ? "selected" : "" %>>A-Z</option>
          <option value="desc" <%= order === "desc" ? "selected" : "" %>>Z-A</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-secondary w-100" type="submit">
          <i class="fa-solid fa-filter"></i> Apply
        </button>
      </div>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <% if (error) { %>
      <div class="alert alert-danger m-3"><%= error %></div>
      <% } %>

      <div class="table-responsive">

        <table class="table table-hover my-2">
          <thead class="table-light">
            <tr>
              <th class="px-4">Word</th>
              <th>Audio</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if (data.length === 0) { %>
            <tr>
              <td colspan="3" class="text-center text-muted py-3">No data found</td>
            </tr>
            <% } else { %>
            <% data.forEach((ele) => { %>
            <tr class="user-row">
              <td class="px-4 p-2"><%= ele.word %></td>
              <td class="play-audio-td">
                <% if (ele.audioFiles.length > 0) { %>
                  <div class="w-100 play-audio" title="Play me">
                    <i class="fa-solid fa-volume-high hoverable-primary pointer text-primary play-audio-player"
                       data-audio="<%= ele.audioFiles[0] %>"></i>
                  </div>
                
                <% } else { %>
                <p class="text-secondary font-size-12 m-0 p-2">No Audio Found</p>
                <% } %>
              </td>
              <td class="text-end">
                <a href="/admin/translations/<%= ele.id %>" class="btn btn-outline-primary btn-sm">
                  <i class="fa-solid fa-arrow-right"></i>
                </a>
              </td>
              
            </tr>
            <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center p-3">
        <p class="m-0">Page <%= currentPage %> of <%= totalPages %></p>

        <div>
          <% if (currentPage > 1) { %>
          <a href="/admin/translations?page=<%= currentPage - 1 %>&query=<%= query %>&filter=<%= filter %>&order=<%= order %>"
            class="btn btn-outline-primary">Previous</a>
          <% } %>

          <% if (currentPage < totalPages) { %>
          <a href="/admin/translations?page=<%= currentPage + 1 %>&query=<%= query %>&filter=<%= filter %>&order=<%= order %>"
            class="btn btn-outline-primary">Next</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('./layout/footer_auth') %>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".play-audio").forEach(container => {
      container.addEventListener("click", function () {

        const audioIcon = container.querySelector(".play-audio-player");
        if (!audioIcon) {
          console.error("No .play-audio-player found inside .play-audio");
          return;
        }

        const audioSrc = audioIcon.getAttribute("data-audio");

        if (!audioSrc || audioSrc === "undefined") {
          console.error("No audio file found!");
          return;
        }

        let existingAudio = document.getElementById("audio-player");
        if (existingAudio) {
          existingAudio.pause();
          existingAudio.currentTime = 0;
          existingAudio.remove();
          
          document.querySelectorAll(".play-audio-player").forEach(icon => {
            icon.classList.remove("fa-circle-play");
            icon.classList.remove("fa-volume-high");
            icon.classList.add("fa-volume-high")
          });
        }

        let audio = document.createElement("audio");
        audio.id = "audio-player";
        audio.src = audioSrc;
        document.body.appendChild(audio);

        audioIcon.classList.remove("fa-volume-high");
        audioIcon.classList.add("fa-circle-play");

        audio.play();

        audio.addEventListener("ended", () => {
          document.querySelectorAll(".play-audio-player").forEach(icon => {
            icon.classList.remove("fa-circle-play");
            icon.classList.remove("fa-volume-high");
            icon.classList.add("fa-volume-high")
          });
        });
      });
    });
  });
</script>
